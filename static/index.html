<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>جدول العيادات الخارجية - مستشفى المقطم التخصصي</title>
<!-- Font Awesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
    :root {
        --dark-green: #2a6465;
        --orange: #f9a825; /* اللون البرتقالي الأساسي الجديد */
        --white: #ffffff;
        --text-dark: #212529;
        --text-muted: #6c757d;
        --whatsapp-green: #25D366;
        --danger-red: #dc3545;
        --primary-glow: rgba(42, 100, 101, 0.4);
        --orange-glow: rgba(249, 168, 37, 0.7);
    }
    html { scroll-behavior: smooth; }
    body {
        font-family: 'Cairo', sans-serif;
        background-color: #f0f2f5;
        margin: 0;
        padding: 20px 15px;
        display: flex;
        justify-content: center;
        color: var(--text-dark);
    }
    .page {
        background: var(--white);
        width: 100%;
        max-width: 900px;
        padding: 25px;
        box-shadow: 0 5px 30px rgba(0,0,0,0.1);
        border-radius: 15px;
        box-sizing: border-box;
        overflow: hidden;
    }
    .logo-container { text-align: center; margin: -25px -25px 25px -25px; }
    .logo-image { width: 100%; height: auto; }
    
    .info-professional {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
        text-align: right;
    }
    .info-professional h1 {
        font-size: 20px;
        margin-top: 0;
        margin-bottom: 5px;
        color: var(--dark-green);
    }
    .info-professional .en-title {
        font-family: 'Poppins', sans-serif;
        font-size: 14px;
        color: var(--text-muted);
        margin-bottom: 20px;
        display: block;
    }
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }
    .info-item { display: flex; align-items: center; gap: 15px; line-height: 1.6; }
    .info-item i { font-size: 22px; color: var(--orange); width: 25px; text-align: center; }
    .info-item-text strong { font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 1.1em; }
    .info-item-text .en { font-family: 'Poppins', sans-serif; font-size: 0.8em; color: var(--text-muted); display: block; }

    .feature-box { text-align: center; margin-bottom: 25px; padding: 20px; background-color: #e6f3f3; border: 1px solid var(--dark-green); border-radius: 10px; }
    .feature-box h2 { font-size: 18px; color: var(--dark-green); margin-top: 0; }
    .feature-box p { font-size: 14px; color: var(--text-muted); }
    .feature-box textarea, .feature-box input[type="text"] { width: 100%; padding: 12px 15px; border-radius: 8px; border: 1px solid #ccc; font-family: 'Cairo', sans-serif; font-size: 14px; margin-bottom: 15px; box-sizing: border-box; }
    .feature-box .input-wrapper { position: relative; display: flex; gap: 10px; align-items: center; }
    .feature-box input[type="text"] { flex-grow: 1; margin-bottom: 0; }
    .feature-box button { background-color: var(--dark-green); color: var(--white); border: none; padding: 10px 20px; font-size: 16px; font-weight: 600; border-radius: 8px; cursor: pointer; transition: all 0.3s; margin: 5px 0; line-height: 1.5; }
    .feature-box button:disabled { background-color: #999; cursor: not-allowed; }
    .feature-box button.go-to-btn { background-color: var(--orange); color: var(--white); }
    #doctor-search-btn {
        background-color: var(--orange);
        color: var(--white); 
        width: 45px;
        height: 45px;
        padding: 0;
        font-size: 18px;
    }
    #analyze-reports-btn {
        background-color: var(--orange);
        color: var(--white);
    }
    .feature-box button:hover:not(:disabled) { opacity: 0.9; transform: translateY(-2px); }
    
    #recommendation-result-container, #analysis-result-container { margin-top: 15px; }
    .recommendation-card { background-color: var(--white); border: 1px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: right; transition: all 0.3s ease; }
    .recommendation-card.primary-recommendation { border: 2px solid var(--dark-green); box-shadow: 0 0 20px var(--primary-glow); }
    .recommendation-header { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
    .recommendation-header .icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative; 
        overflow: hidden; 
    }
    .recommendation-card.primary-recommendation .recommendation-header .icon { animation: pulse 1.5s infinite ease-in-out; }
    
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

    .recommendation-header .icon .svg-icon {
        width: 100%; height: 100%; -webkit-mask-size: contain; mask-size: contain;
        -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat; background-color: var(--dark-green); 
    }
    .recommendation-header .icon .fa-solid { font-size: 28px; color: var(--dark-green); }
    .recommendation-header h3 { margin: 0; font-size: 20px; color: var(--text-dark); }
    .recommendation-badge { background-color: var(--dark-green); color: white; font-size: 11px; font-weight: bold; padding: 3px 8px; border-radius: 12px; margin-right: auto; }
    .recommendation-reason { font-size: 15px; line-height: 1.8; color: var(--text-muted); margin-bottom: 15px; text-align: justify; }
    
    #search-results-container { margin-top: 15px; text-align: right; }
    #search-results-container .result-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
    #search-results-container .result-item:last-child { border-bottom: none; }
    .result-info strong { font-size: 1em; color: var(--text-dark); }
    .result-info .clinic-name { font-size: 0.8em; color: var(--text-muted); }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--dark-green); border-radius: 50%; width: 25px; height: 25px; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .section-title { background-color: var(--dark-green); color: var(--white); padding: 12px 20px; border-radius: 10px; margin-top: 35px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
    .section-title .icon { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; }
    .section-title .icon .svg-icon {
        width: 100%; height: 100%; background-color: var(--white); -webkit-mask-size: contain;
        mask-size: contain; -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat;
    }
    .section-title .icon .fa-solid { font-size: 28px; }
    .section-title .title-text { flex-grow: 1; }
    .section-title .title-text h2 { font-size: 20px; font-weight: 700; margin:0; }
    .section-title .title-text h3 { font-family: 'Poppins', sans-serif; font-size: 14px; font-weight: 400; opacity: 0.9; margin:0; }
    
    .doctor-card { display: block; margin-bottom: 15px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #eee; transition: all 0.3s; }
    .doctor-card.highlight { box-shadow: 0 0 15px 5px var(--orange-glow); transform: scale(1.02); border-color: var(--orange); }
    .doctor-card .doctor-name { background-color: #f8f9fa; text-align: center; padding: 12px; font-size: 16px; font-weight: 600; }
    .doctor-card .appointment { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; font-size: 14px; border-bottom: 1px solid #eee; }
    .doctor-card .appointment:last-child { border-bottom: none; }
    .doctor-card .day { font-weight: bold; color: var(--dark-green); text-align: right; }
    .doctor-card .day .en, .doctor-card .doctor-name .en { font-family: 'Poppins', sans-serif; font-size: 0.85em; font-weight: 400; margin-top: 2px; color: #555;}
    .doctor-card .time { font-weight: 600; font-family: 'Poppins', sans-serif; font-size: 15px; background-color: var(--orange); color: var(--white); padding: 3px 10px; border-radius: 5px; }
    .en { font-family: 'Poppins', sans-serif; font-size: 0.9em; font-weight: 400; margin-top: 2px; }
    
    /* --- AI Analyzer Styles --- */
    .upload-area { border: 2px dashed #ccc; border-radius: 10px; padding: 20px; margin-bottom: 15px; transition: border-color 0.3s, background-color 0.3s; }
    .upload-area.drag-over { border-color: var(--dark-green); background-color: #e6f3f3; }
    #report-files-input { display: none; }
    .upload-label { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; color: var(--text-muted); }
    .upload-label i { font-size: 36px; margin-bottom: 10px; color: var(--dark-green); }
    .upload-label span { font-size: 16px; font-weight: 600; }
    #file-preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; justify-content: center; }
    .preview-item { position: relative; width: 80px; height: 80px; }
    .preview-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
    .preview-item .file-icon {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        width: 100%; height: 100%; background-color: #f0f2f5; border-radius: 8px; border: 1px solid #ddd;
    }
    .preview-item .file-icon i { font-size: 30px; color: var(--dark-green); }
    .preview-item .file-icon span {
        font-size: 10px; color: var(--text-muted); margin-top: 5px;
        word-break: break-all; overflow: hidden; text-overflow: ellipsis;
        display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
    }
    .remove-file-btn {
        position: absolute; top: -5px; right: -5px; width: 20px; height: 20px;
        background-color: var(--danger-red); color: white; border: none; border-radius: 50%;
        cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; z-index: 1;
    }
    .analysis-card { background-color: var(--white); border: 2px solid var(--dark-green); box-shadow: 0 0 20px var(--primary-glow); border-radius: 10px; padding: 20px; text-align: right; }
    .analysis-card .disclaimer { background-color: #fff3cd; border-right: 5px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .analysis-card .disclaimer strong { color: #856404; }
    .analysis-section-title { font-size: 18px; font-weight: 700; color: var(--dark-green); margin-top: 20px; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid var(--orange); }
    .analysis-card ul { padding-right: 20px; margin: 0; }
    .analysis-card li { margin-bottom: 10px; line-height: 1.8; }
</style>
</head>
<body>

<div class="page" id="page-top">
    <div class="logo-container"><img src="https://i.ibb.co/jv4t9yMt/LOGO-1.png" alt="Mokattam Specialized Hospital Logo" class="logo-image"></div>
    
    <div class="info-professional">
        <h1>نتشرف باستقبال حضراتكم بالعيادات الخارجية</h1>
        <span class="en-title">We are honored to welcome you at the Outpatient Clinics</span>
        <div class="info-grid">
            <div class="info-item">
                <i class="fa-solid fa-phone"></i>
                <div class="info-item-text"> للحجز والاستفسار: <strong>16897</strong> <span class="en">For booking & inquiries</span> </div>
            </div>
            <div class="info-item">
                <i class="fa-brands fa-whatsapp"></i>
                <div class="info-item-text"> واتساب: <strong>01033366629</strong> <span class="en">WhatsApp</span> </div>
            </div>
            <div class="info-item">
                <i class="fa-solid fa-map-marker-alt"></i>
                <div class="info-item-text"> العنوان: <strong>شارع 9 - المقطم - القاهرة</strong> <span class="en">Address: Street 9, Mokattam, Cairo</span> </div>
            </div>
            <div class="info-item">
                <i class="fa-solid fa-receipt"></i>
                <div class="info-item-text"> الرقم الضريبي: <strong>٠٠٨-٤٨٩-٦٩٩</strong> <span class="en">Tax ID: 699-489-008</span> </div>
            </div>
        </div>
    </div>

    <!-- AI Report Analyzer -->
    <div class="feature-box">
        <h2>🔬 المحلل الذكي للتقارير الطبية</h2>
        <p>ارفع صور أو ملفات (PDF) للتحاليل أو الأشعة وسيقوم المساعد الذكي بتحليلها، وتوجيهك للعيادة المناسبة، وتقديم نصائح أولية.</p>
        <div class="upload-area" id="upload-area">
            <input type="file" id="report-files-input" multiple accept="image/png, image/jpeg, image/webp, application/pdf">
            <label for="report-files-input" class="upload-label">
                <i class="fa-solid fa-cloud-arrow-up"></i>
                <span>اختر صور أو ملفات التقارير أو اسحبها إلى هنا</span>
            </label>
            <div id="file-preview-container"></div>
        </div>
        <textarea id="user-notes-input" placeholder="يمكنك إضافة أي ملاحظات أو أسئلة هنا... (اختياري)"></textarea>
        <button id="analyze-reports-btn" disabled><i class="fa-solid fa-microscope"></i> حلل الآن</button>
        <div id="analysis-loader" class="loader"></div>
        <div id="analysis-result-container"></div>
    </div>

    <!-- Smart Clinic Recommendation -->
    <div class="feature-box">
        <h2>لست متأكدًا أي عيادة تختار؟</h2>
        <p>صف لنا الأعراض التي تشعر بها، وسيقوم المساعد الذكي باقتراح التخصص الأنسب لك.</p>
        <textarea id="symptoms-input" placeholder="مثال: أشعر بألم حاد في جنبي الأيمن وحرقان في البول..."></textarea>
        <button id="get-recommendation-btn">✨ أرشدني للعيادة الصحيحة</button>
        <div id="loader" class="loader"></div>
        <div id="recommendation-result-container"></div>
    </div>
    
    <!-- Clinics Content -->
    <div id="clinics-container"></div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Data is now embedded for simplicity. In a real app, this might come from an API.
    const clinicsDisplayData = [
        { id: "الباطنة-العامة", name: "الباطنة العامة", en_name: "General Medicine", icon: "fa-stethoscope", isSvg: false },
        { id: "غدد-صماء-وسكر", name: "غدد صماء وسكر", en_name: "Endocrinology & Diabetes", icon: "endocrinology.svg", isSvg: true },
        { id: "جهاز-هضمي-ومناظير", name: "جهاز هضمي ومناظير", en_name: "Gastroenterology & Endoscopy", icon: "gastroenterology.svg", isSvg: true },
        { id: "باطنة-وقلب", name: "باطنة وقلب", en_name: "Internal Medicine & Cardiology", icon: "internal-medicine-cardiology.svg", isSvg: true },
        { id: "الجراحة-العامة", name: "الجراحة العامة", en_name: "General Surgery", icon: "general-surgery.svg", isSvg: true },
        { id: "مناعة-وروماتيزم", name: "مناعة وروماتيزم", en_name: "Immunology & Rheumatology", icon: "immunology.svg", isSvg: true },
        { id: "نساء-وتوليد", name: "نساء وتوليد", en_name: "Obstetrics & Gynecology", icon: "obgyn.svg", isSvg: true },
        { id: "أنف-وأذن-وحنجرة", name: "أنف وأذن وحنجرة", en_name: "ENT", icon: "ent.svg", isSvg: true },
        { id: "الصدر", name: "الصدر", en_name: "Pulmonology", icon: "pulmonology.svg", isSvg: true },
        { id: "أمراض-الذكورة", name: "أمراض الذكورة", en_name: "Andrology", icon: "fa-mars", isSvg: false },
        { id: "الجلدية", name: "الجلدية", en_name: "Dermatology", icon: "dermatology.svg", isSvg: true },
        { id: "العظام", name: "العظام", en_name: "Orthopedics", icon: "orthopedics.svg", isSvg: true },
        { id: "المخ-والأعصاب-باطنة", name: "المخ والأعصاب (باطنة)", en_name: "Neurology", icon: "neurology.svg", isSvg: true },
        { id: "جراحة-المخ-والأعصاب", name: "جراحة المخ والأعصاب", en_name: "Neurosurgery", icon: "fa-user-md", isSvg: false },
        { id: "المسالك-البولية", name: "المسالك البولية", en_name: "Urology", icon: "urology.svg", isSvg: true },
        { id: "الأوعية-الدموية", name: "الأوعية الدموية", en_name: "Vascular", icon: "vascular.svg", isSvg: true },
        { id: "الأطفال", name: "الأطفال", en_name: "Pediatrics", icon: "pediatrics.svg", isSvg: true },
        { id: "الرمد", name: "الرمد", en_name: "Ophthalmology", icon: "ophthalmology.svg", isSvg: true },
        { id: "تغذية-الأطفال", name: "تغذية الأطفال", en_name: "Pediatric Nutrition", icon: "fa-apple-whole", isSvg: false },
        { id: "مناعة-وحساسية-الأطفال", name: "مناعة وحساسية الأطفال", en_name: "Pediatric Immunology & Allergy", icon: "pediatric-immunology.svg", isSvg: true },
        { id: "القلب", name: "القلب", en_name: "Cardiology", icon: "fa-heart-circle-check", isSvg: false },
        { id: "رسم-قلب-بالمجهود-وإيكو", name: "رسم قلب بالمجهود وإيكو", en_name: "Stress ECG & Echocardiography", icon: "fa-wave-square", isSvg: false },
        { id: "جراحة-التجميل", name: "جراحة التجميل", en_name: "Plastic Surgery", icon: "fa-wand-magic-sparkles", isSvg: false },
        { id: "علاج-البواسير-والشرخ-بالليزر", name: "علاج البواسير والشرخ بالليزر", en_name: "Laser Proctology", icon: "fa-crosshairs", isSvg: false },
        { id: "الأسنان", name: "الأسنان", en_name: "Dentistry", icon: "fa-tooth", isSvg: false },
        { id: "السمعيات", name: "السمعيات", en_name: "Audiology", icon: "fa-assistive-listening-systems", isSvg: false },
        { id: "أمراض-الدم", name: "أمراض الدم", en_name: "Hematology", icon: "hematology.svg", isSvg: true },
    ];
    const clinicMap = new Map(clinicsDisplayData.map(c => [c.id, {name: c.name, icon: c.icon, isSvg: c.isSvg}]));
    
    // --- API Endpoints ---
    // Note: These are relative paths because the frontend and backend are served from the same domain.
    const RECOMMEND_API = '/api/recommend';
    const ANALYZE_API = '/api/analyze';

    // Symptoms Recommendation Logic
    const getRecommendationBtn = document.getElementById('get-recommendation-btn');
    const symptomsInput = document.getElementById('symptoms-input');
    const recommendationResultContainer = document.getElementById('recommendation-result-container');
    const loader = document.getElementById('loader');
    
    getRecommendationBtn.addEventListener('click', async () => {
        const symptomsText = symptomsInput.value.trim();
        if (!symptomsText) {
            alert('من فضلك، قم بوصف الأعراض التي تشعر بها.');
            return;
        }

        loader.style.display = 'block';
        recommendationResultContainer.innerHTML = '';
        getRecommendationBtn.disabled = true;

        try {
            const response = await fetch(RECOMMEND_API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symptoms: symptomsText })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({error: "حدث خطأ في الاتصال بالخادم."}));
                throw new Error(errorData.error);
            }
            
            const data = await response.json();
            if (data.recommendations && data.recommendations.length > 0) {
                displayRecommendations(data.recommendations);
            } else {
                 displayFallback();
            }

        } catch (error) {
            console.error("Error:", error);
            displayFallback(`عفواً، حدث خطأ تقني: ${error.message}`);
        } finally {
            loader.style.display = 'none';
            getRecommendationBtn.disabled = false;
        }
    });
    
    function displayRecommendations(recommendations) {
        recommendationResultContainer.innerHTML = '';
        recommendations.forEach((rec, index) => {
            const clinicInfo = clinicMap.get(rec.id);
            if (!clinicInfo) return;

            const isPrimary = index === 0;
            const card = document.createElement('div');
            card.className = `recommendation-card ${isPrimary ? 'primary-recommendation' : ''}`;
            
            const iconHtml = clinicInfo.isSvg 
                ? `<div class="svg-icon" style="-webkit-mask-image: url(./icons/${clinicInfo.icon}); mask-image: url(./icons/${clinicInfo.icon});"></div>`
                : `<i class="fa-solid ${clinicInfo.icon}"></i>`;

            card.innerHTML = `
                <div class="recommendation-header">
                    <div class="icon">${iconHtml}</div>
                    <h3>${clinicInfo.name}</h3>
                    ${isPrimary ? '<span class="recommendation-badge">الترشيح الأنسب</span>' : '<span class="recommendation-badge" style="background-color: #6c757d;">ترشيح بديل</span>'}
                </div>
                <p class="recommendation-reason">${rec.reason}</p>
                <button class="go-to-btn" onclick="scrollToClinic('${rec.id}')">اذهب إلى عيادة ${clinicInfo.name} <i class="fa-solid fa-arrow-down"></i></button>
            `;
            recommendationResultContainer.appendChild(card);
        });
    }

    function displayFallback(message = null) {
        const fallbackMessage = message || 'لم نتمكن من تحديد تخصص دقيق. نقترح عليك التوجه لعيادة <strong>الباطنة العامة</strong> كنقطة بداية.';
        const clinicInfo = clinicMap.get("الباطنة-العامة");
        const iconHtml = `<i class="fa-solid ${clinicInfo.icon}"></i>`;
        
        recommendationResultContainer.innerHTML = `
            <div class="recommendation-card primary-recommendation">
                 <div class="recommendation-header">
                    <div class="icon">${iconHtml}</div>
                    <h3>الباطنة العامة</h3>
                    <span class="recommendation-badge">الترشيح المبدئي</span>
                </div>
                <p class="recommendation-reason">${fallbackMessage}</p>
                <button class="go-to-btn" onclick="scrollToClinic('الباطنة-العامة')">اذهب إلى عيادة الباطنة العامة <i class="fa-solid fa-arrow-down"></i></button>
            </div>
        `;
    }

    window.scrollToClinic = (clinicId) => {
        // Since clinic sections are not rendered on this page, we show an alert.
        // In a full implementation, you would scroll to the element.
        alert(`تم تحديد عيادة: ${clinicId}. في التطبيق الكامل، سيتم التمرير إلى قسم هذه العيادة.`);
    };

    // --- AI Analyzer Logic ---
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('report-files-input');
    const previewContainer = document.getElementById('file-preview-container');
    const analyzeBtn = document.getElementById('analyze-reports-btn');
    const analysisLoader = document.getElementById('analysis-loader');
    const analysisResultContainer = document.getElementById('analysis-result-container');
    const userNotesInput = document.getElementById('user-notes-input');
    let uploadedFiles = [];

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
    });
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => uploadArea.classList.add('drag-over'), false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('drag-over'), false);
    });
    uploadArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        let dt = e.dataTransfer;
        let files = dt.files;
        handleFiles(files);
    }

    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });

    function handleFiles(files) {
        [...files].forEach(file => {
            if (file.size > 5 * 1024 * 1024) {
                alert(`الملف "${file.name}" كبير جدًا (أكثر من 5 ميجابايت) ولن يتم رفعه.`);
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const fileData = {
                    name: file.name,
                    base64: e.target.result,
                    mimeType: file.type || 'application/octet-stream'
                };
                uploadedFiles.push(fileData);
                renderPreviews();
            };
            reader.readAsDataURL(file);
        });
    }

    function renderPreviews() {
        previewContainer.innerHTML = '';
        uploadedFiles.forEach((fileData, index) => {
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            
            let filePreviewHtml = fileData.mimeType.startsWith('image/')
                ? `<img src="${fileData.base64}" alt="${fileData.name}">`
                : `<div class="file-icon"><i class="fa-solid fa-file-pdf"></i><span>${fileData.name}</span></div>`;

            previewItem.innerHTML = `
                ${filePreviewHtml}
                <button class="remove-file-btn" data-index="${index}">&times;</button>
            `;
            previewContainer.appendChild(previewItem);
        });
        updateAnalyzeButtonState();
    }

    previewContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-file-btn')) {
            const index = parseInt(e.target.dataset.index, 10);
            uploadedFiles.splice(index, 1);
            renderPreviews();
        }
    });

    function updateAnalyzeButtonState() {
        analyzeBtn.disabled = uploadedFiles.length === 0;
    }

    analyzeBtn.addEventListener('click', async () => {
        if (uploadedFiles.length === 0) return;

        analysisLoader.style.display = 'block';
        analysisResultContainer.innerHTML = '';
        analyzeBtn.disabled = true;

        const filesPayload = uploadedFiles.map(file => ({
            mime_type: file.mimeType,
            data: file.base64.split(',')[1]
        }));

        try {
            const response = await fetch(ANALYZE_API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    files: filesPayload,
                    notes: userNotesInput.value 
                })
            });

            if (!response.ok) {
                 const errorData = await response.json().catch(() => ({error: "حدث خطأ في الخادم. قد يكون الملف غير مدعوم."}));
                throw new Error(errorData.error);
            }

            const data = await response.json();
            displayAnalysisResult(data);

        } catch (error) {
            console.error("Analysis Error:", error);
            analysisResultContainer.innerHTML = `<div class="analysis-card"><p>عفواً، حدث خطأ تقني: ${error.message}. يرجى التأكد من أن الملفات واضحة والمحاولة مرة أخرى.</p></div>`;
        } finally {
            analysisLoader.style.display = 'none';
            updateAnalyzeButtonState();
        }
    });

    function displayAnalysisResult(data) {
        analysisResultContainer.innerHTML = '';
        const card = document.createElement('div');
        card.className = 'analysis-card';

        let recommendationsHtml = '';
        if (data.recommendations && data.recommendations.length > 0 && data.recommendations[0].id) {
            const rec = data.recommendations[0];
            const clinicInfo = clinicMap.get(rec.id);
            if (clinicInfo) {
                const iconHtml = clinicInfo.isSvg 
                    ? `<div class="svg-icon" style="-webkit-mask-image: url(./icons/${clinicInfo.icon}); mask-image: url(./icons/${clinicInfo.icon});"></div>`
                    : `<i class="fa-solid ${clinicInfo.icon}"></i>`;
                recommendationsHtml = `
                    <h3 class="analysis-section-title">العيادة الموصى بها</h3>
                    <div class="recommendation-header" style="margin-bottom: 15px;">
                        <div class="icon">${iconHtml}</div>
                        <h3>${clinicInfo.name}</h3>
                    </div>
                    <p>${rec.reason || 'نوصي بزيارة هذه العيادة للمتابعة.'}</p>
                    <button class="go-to-btn" style="margin-top: 15px;" onclick="alert('سيتم التوجيه لعيادة ${clinicInfo.name}')">اذهب إلى العيادة <i class="fa-solid fa-arrow-down"></i></button>
                `;
            }
        }
        
        card.innerHTML = `
            <div class="disclaimer">
                <i class="fa-solid fa-triangle-exclamation"></i> <strong>تنبيه هام:</strong> هذا التحليل هو مجرد إرشاد أولي مقدم من مساعد ذكي ولا يغني إطلاقًا عن استشارة الطبيب المختص.
            </div>

            <h3 class="analysis-section-title">شرح مبسط للتقرير</h3>
            <p>${data.interpretation || 'لم يتمكن المساعد من تقديم شرح واضح. يرجى استشارة الطبيب.'}</p>

            <h3 class="analysis-section-title">نصائح وإرشادات مؤقتة</h3>
            <ul>
                ${(data.temporary_advice && data.temporary_advice.length > 0) ? data.temporary_advice.map(item => `<li>${item}</li>`).join('') : '<li>لا توجد نصائح محددة. يرجى استشارة الطبيب.</li>'}
            </ul>
            
            ${recommendationsHtml}
        `;
        analysisResultContainer.appendChild(card);
    }
});
</script>

</body>
</html>
